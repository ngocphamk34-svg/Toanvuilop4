<!doctype html>
<html lang="vi">
<head>
<meta charset="utf-8">
<title>AI To√°n Vui - L·ªõp 4</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<link href="https://fonts.googleapis.com/css2?family=Comic+Neue:wght@400;700&display=swap" rel="stylesheet">
<style>
body {
  font-family: 'Comic Neue', Arial, sans-serif;
  background: linear-gradient(135deg, #FFECB3, #B3E5FC);
  margin: 0;
  padding: 20px;
  display: flex;
  flex-direction: column;
  align-items: center;
  min-height: 100vh;
  color: #333;
}

h1 {
  text-align: center;
  margin: 10px 0 20px 0;
  color: #FF5722;
  text-shadow: 1px 1px 2px #fff;
}

#problem-card {
  display: inline-block; /* v·ª´a n·ªôi dung */
  padding: 15px 25px;
  background: #FFF9C4;
  border-radius: 20px;
  box-shadow: 3px 3px 15px rgba(0,0,0,0.2);
  text-align: center;
  font-size: 2em;
  margin: 20px 0;
  transition: transform 0.3s;
  max-width: 90%; /* tr√°nh tr√†n ra tr√™n ƒëi·ªán tho·∫°i */
  word-wrap: break-word;
}

#controls {
  display: flex;
  flex-wrap: wrap;
  justify-content: center;
  margin-bottom: 20px;
}

button {
  padding: 12px 20px;
  margin: 8px;
  font-size: 1.1em;
  border: none;
  border-radius: 12px;
  cursor: pointer;
  transition: 0.3s;
  color: #fff;
  background-color: #FF7043;
  box-shadow: 2px 2px 6px rgba(0,0,0,0.2);
}

button:hover { background-color: #F4511E; transform: scale(1.05); }

#feedback {
  font-size: 1.4em;
  margin-bottom: 20px;
  min-height: 1.6em;
}

.ok { color: green; animation: pulse 0.5s; }
.bad { color: red; animation: shake 0.5s; }

#log {
  max-width: 720px;
  width: 90%;
  margin-bottom: 30px;
}

@keyframes shake {
  0% { transform: translateX(0); }
  25% { transform: translateX(-5px); }
  50% { transform: translateX(5px); }
  75% { transform: translateX(-5px); }
  100% { transform: translateX(0); }
}

@keyframes pulse {
  0% { transform: scale(1); }
  50% { transform: scale(1.1); }
  100% { transform: scale(1); }
}

select { padding:6px 10px; margin:0 6px; font-size:1em; border-radius:8px; }
</style>
</head>
<body>

<h1>ü§ñ AI To√°n Vui (L·ªõp 4)</h1>

<div>
  <label>Lo·∫°i to√°n:
    <select id="mode">
      <option value="add">C·ªông</option>
      <option value="sub">Tr·ª´</option>
      <option value="mul">Nh√¢n</option>
      <option value="div">Chia</option>
      <option value="mix" selected>Tr·ªôn</option>
    </select>
  </label>
  <label>
    ƒê·ªô kh√≥:
    <select id="difficulty">
      <option value="easy">D·ªÖ</option>
      <option value="normal" selected>Trung b√¨nh</option>
      <option value="hard">Kh√≥</option>
    </select>
  </label>
</div>

<div id="problem-card">Nh·∫•n "T·∫°o ph√©p t√≠nh" ƒë·ªÉ b·∫Øt ƒë·∫ßu</div>

<div id="controls">
  <button id="newBtn">T·∫°o ph√©p t√≠nh</button>
  <button id="speakBtn">ƒê·ªçc b√†i to√°n</button>
  <button id="listenBtn">B·∫Øt ƒë·∫ßu nghe</button>
  <button id="skipBtn">B·ªè qua</button>
</div>

<div id="feedback"></div>
<div id="log"></div>

<script>
function randInt(a,b){return Math.floor(Math.random()*(b-a+1))+a;}

function genProblem(mode,diff){
  let a,b,question,answer,factor;
  if(mode==='mix') mode=['add','sub','mul','div'][randInt(0,3)];

  if(mode==='add'){
    a=randInt(10,99); b=randInt(10,99);
    if(diff==='normal'){a=randInt(50,200);b=randInt(50,200);}
    else if(diff==='hard'){a=randInt(100,500);b=randInt(50,400);}
    answer=a+b;
    question=`${a} + ${b} = ?`;
  }
  else if(mode==='sub'){
    a=randInt(20,99); b=randInt(10,49);
    if(diff==='normal'){a=randInt(50,200);b=randInt(20,150);}
    else if(diff==='hard'){a=randInt(100,500);b=randInt(50,400);}
    if(a<b)[a,b]=[b,a];
    answer=a-b;
    question=`${a} - ${b} = ?`;
  }
  else if(mode==='mul'){
    a=randInt(1,12); factor=randInt(1,12);
    if(diff==='normal'){a=randInt(2,12); factor=randInt(2,12);}
    else if(diff==='hard'){a=randInt(5,20); factor=randInt(2,12);}
    answer=a*factor;
    question=`${a} √ó ${factor} = ?`;
  }
  else if(mode==='div'){
    let divisor=randInt(2,12), quotient=randInt(1,12);
    if(diff==='normal') quotient=randInt(2,20);
    else if(diff==='hard') quotient=randInt(5,50);
    a=divisor*quotient; b=divisor; answer=quotient;
    question=`${a} √∑ ${b} = ?`;
  }

  // T·∫°o phi√™n b·∫£n ƒë·ªçc ra ti·∫øng Vi·ªát
  let questionRead = question
      .replace(/\+/g,' c·ªông ')
      .replace(/\-/g,' tr·ª´ ')
      .replace(/√ó/g,' nh√¢n ')
      .replace(/√∑/g,' chia ')
      .replace(/\=/g,' b·∫±ng ');

  return {question, questionRead, answer};
}

let current=null;
const problemEl=document.getElementById('problem-card');
const feedbackEl=document.getElementById('feedback');
const logEl=document.getElementById('log');

function log(text){ const p=document.createElement('div'); p.textContent=`${new Date().toLocaleTimeString()} - ${text}`; logEl.prepend(p); }

function normalizeNumberString(s){ s=s.replace(/[^\d\-]/g,' ').trim(); if(s.length===0) return null; const parts=s.split(/\s+/); for(let i=parts.length-1;i>=0;i--){if(/\d+/.test(parts[i])) return parseInt(parts[i],10);} const n=parseInt(s,10); return isNaN(n)?null:n; }

function checkAnswer(text){
  if(!current) return;
  let userNum=normalizeNumberString(text);
  if(userNum===null){ feedbackEl.textContent='Kh√¥ng nh·∫≠n d·∫°ng ƒë∆∞·ª£c s·ªë, h√£y th·ª≠ l·∫°i.'; return;}
  if(userNum===current.answer){
    feedbackEl.innerHTML=`<span class="ok">ƒê√∫ng! üéâ</span>`;
    log(`ƒê√∫ng: ${current.question} ‚Üí ${userNum}`);
    speak('B·∫°n tr·∫£ l·ªùi ƒë√∫ng!');
  }
  else {
    feedbackEl.innerHTML=`<span class="bad">Sai. B·∫°n n√≥i ${userNum}, ƒë√°p √°n: ${current.answer}</span>`;
    log(`Sai: ${current.question} ‚Üí ${userNum} (ƒê√°p: ${current.answer})`);
    speak(`Sai, ƒë√°p √°n l√† ${current.answer}`);
  }
  current=null;
  problemEl.textContent='Nh·∫•n "T·∫°o ph√©p t√≠nh" ƒë·ªÉ ti·∫øp t·ª•c';
}

function speak(text){ 
  if(!('speechSynthesis' in window)) return; 
  const ut=new SpeechSynthesisUtterance(text); 
  ut.lang='vi-VN'; 
  window.speechSynthesis.cancel(); 
  window.speechSynthesis.speak(ut); 
}

// T·∫°o ph√©p t√≠nh m·ªõi
document.getElementById('newBtn').onclick=()=>{
  const mode=document.getElementById('mode').value;
  const diff=document.getElementById('difficulty').value;
  current=genProblem(mode,diff);
  problemEl.textContent=current.question;
  feedbackEl.textContent='';
};

// ƒê·ªçc b√†i to√°n
document.getElementById('speakBtn').onclick=()=>{
  if(!current){ alert('H√£y t·∫°o ph√©p t√≠nh tr∆∞·ªõc'); return; }
  speak(current.questionRead);
};

// Nh·∫≠n di·ªán gi·ªçng n√≥i
const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
let recognition;
if(SpeechRecognition){
  recognition=new SpeechRecognition();
  recognition.lang='vi-VN';
  recognition.interimResults=false;
  recognition.maxAlternatives=1;
  recognition.onresult=(e)=>{ 
    const text=e.results[0][0].transcript.trim(); 
    feedbackEl.textContent=`B·∫°n n√≥i: "${text}"`; 
    checkAnswer(text);
  }
}

document.getElementById('listenBtn').onclick=()=>{
  if(!recognition){alert('Tr√¨nh duy·ªát kh√¥ng h·ªó tr·ª£ nh·∫≠n di·ªán gi·ªçng n√≥i'); return;} 
  if(!current){alert('H√£y t·∫°o ph√©p t√≠nh tr∆∞·ªõc'); return;} 
  feedbackEl.textContent='ƒêang l·∫Øng nghe...'; 
  recognition.start(); 
};

// B·ªè qua
document.getElementById('skipBtn').onclick=()=>{
  if(!current){alert('Ch∆∞a c√≥ ph√©p t√≠nh'); return;} 
  log(`${current.question} (ƒê√°p: ${current.answer})`); 
  current=null; 
  problemEl.textContent='Nh·∫•n "T·∫°o ph√©p t√≠nh" ƒë·ªÉ ti·∫øp t·ª•c'; 
  feedbackEl.textContent='';
};

// T·∫°o ph√©p t√≠nh ƒë·∫ßu ti√™n khi load trang
document.getElementById('newBtn').click();
</script>
</body>
</html>
